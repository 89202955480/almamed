<script type="text/javascript">
    ;(function(document, window, undefined){
        
        window.scriptsAppendHead = function(scripts, eventName) {
            var src;
            var script;
            var pendingScripts = [];
            var firstScript = document.scripts[0];
            
            function stateChange() {
                // выполняем по порядку столько скриптов, сколько можем.
                var pendingScript;
                while (pendingScripts[0] && pendingScripts[0].readyState == 'loaded') {
                    pendingScript = pendingScripts.shift();
                    // больше не будем загружать события от этого скрипта (например, если меняется src)
                    pendingScript.onreadystatechange = null;
                    // нельзя просто выполнить appendChild — старый баг в IE, если элемент не закрыт.
                    firstScript.parentNode.insertBefore(pendingScript, firstScript);
                    
                    // создаем событие готовности последнего скрипта в пачке
                    if (typeof(eventName) !== 'undefined' && pendingScript.getAttribute("flag")) {
                        var event = document.createEvent("HTMLEvents");
                        event.initEvent(eventName, true, false);
                        document.dispatchEvent(event);
                    }
                }
            };
            
            // проходимся через наши ссылки на скрипты
            while (src = scripts.shift()) {
                if ('async' in firstScript) { // современные браузеры
                    script = document.createElement('script');
                    script.async = false;
                    script.src = src;
                    script.type = 'text/javascript';
                    document.head.appendChild(script);
                    
                    if (typeof(eventName) !== 'undefined' && !scripts.length) {
                        script.onload = script.onerror = function() {
                            if (!this.executed) { // выполнится только один раз
                                this.executed = true;
                                // создаем событие готовности последнего скрипта в пачке
                                var event = document.createEvent("HTMLEvents");
                                event.initEvent(eventName, true, false);
                                document.dispatchEvent(event);
                            }
                        };
                        script.onreadystatechange = function() {
                            var self = this;
                            if (this.readyState == "complete" || this.readyState == "loaded") {
                                setTimeout(function() {
                                    self.onload()
                                }, 0); // сохранить "this" для onload
                            }
                        };
                    }
                } else if (firstScript.readyState) { // IE<10
                    // создаем скрипт и добавляем его в наш список
                    script = document.createElement('script');
                    script.type = 'text/javascript';
                    // создаем флаг события готовности последнего скрипта в пачке
                    if (typeof(eventName) !== 'undefined' && !scripts.length) {
                        script.setAttribute("flag", true) ;
                    }
                    pendingScripts.push(script);
                    // смотрим за изменением состояния
                    script.onreadystatechange = stateChange;
                    // устанавливать src нужно только после того, как добавляем обработчик на onreadystatechange
                    // иначе не поймаем событие загрузки для кэшированных скриптов
                    script.src = src;
                } else { // ничего не получилось, пишем код через defer
                    document.write('<script type="text/javascript" src="' + src + '" defer></'+'script>');
                }
            }
        };
        
        window.linksAppendHead = function(links, elem) {
            links.forEach(function(href) {
                var link = document.createElement('link');
                link.href = href;
                link.rel = 'stylesheet';
                link.type = 'text/css';
                if (typeof elem === 'undefined') {
                    document.head.appendChild(link);
                } else {
                    document.head.insertBefore(link, elem);
                }
            });
        };
    
        // make stacks
        window.stack_css = [];
        window.stack_css.push('//fonts.googleapis.com/css?family=Roboto:400,700,400italic,700italic&amp;subset=cyrillic,latin');
        window.stack_css.push('//fonts.googleapis.com/icon?family=Material+Icons');
        {if $wa->shop && $wa->shop->currency() == 'RUB'}window.stack_css.push("{$wa_url}wa-content/font/ruble/arial/fontface.css");{/if}
        window.stack_css.push('{$wa_theme_url}profitbuy.min.css');
        window.stack_css.push('{$wa_theme_url}mdi.min.css');
        
        window.stack_js = [];
        window.stack_js.push('{$wa_static_url}wa-content/js/jquery/jquery-1.11.1.min.js');
        window.stack_js.push('{$wa_static_url}wa-content/js/jquery/jquery-migrate-1.2.1.min.js');
        window.stack_js.push('{$wa_theme_url}profitbuy.min.js?v{$wa_theme_version}');
        
        window.stack_inline_js = [];
    
        var re = /(<script\b[^>]*>[\s\S]*?<\/script>)/gm,
            re_src = /src=["'](\S*?)["']/,
            match,
            re2 = /(<link\b[^>]*>)/gm,
            re_href = /href=["'](\S*?)["']/,
            match2;
            
        while (match2 = re2.exec({json_encode($wa->css())})) {
            var link = re_href.exec(match2[0]);
            if (link) {
                window.stack_css.push(link[1]);
            }
        }    
        
        while (match = re.exec({json_encode($wa->js())})) {
            var script = re_src.exec(match[0]);
            if (script) {
                window.stack_js.push(script[1]);
            } else {
                window.stack_inline_js.push(match[0].replace(/<script\b[^>]*>/, "").replace(/<\/script>/, ""));
            }
        }
    
    })(document, window);
</script>
{include file="theme.script.html" inline}